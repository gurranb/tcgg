name: Build and Test Workflow

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    env:
      MY_PATH: TCGGAPI/TCGGAPI.sln
      MY_TEST: TCGGAPI/TCGGAPI.Tests/TCGGAPI.Tests.csproj
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Restore .NET dependencies
        run: dotnet restore "$MY_PATH"

      - name: Build the project
        run: dotnet build "$MY_PATH" --configuration Release
        
      - name: Run tests
        run: dotnet test "$MY_TEST" --configuration Release

  notify-discord:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code again
        uses: actions/checkout@v4

      - name: Calculate line changes
        id: line_changes
        run: |
          ADDED=$(git diff --stat HEAD~1 HEAD | awk '/changed/ {print $4}')
          DELETED=$(git diff --stat HEAD~1 HEAD | awk '/changed/ {print $6}')
          TOTAL=$((ADDED + DELETED))
          echo "ADDED=$ADDED" >> $GITHUB_ENV
          echo "DELETED=$DELETED" >> $GITHUB_ENV
          echo "TOTAL=$TOTAL" >> $GITHUB_ENV

      - name: Install cloc
        run: sudo apt-get install -y clock

      - name: Count total lines of code
        id: total_lines
        run: |
          cloc . --json > cloc.json
          TOTAL_LINES=$(jq .SUM.code cloc.json)
          echo "TOTAL_LINES=$TOTAL_LINES" >> $GITHUB_ENV
        
      - name: Send Discord notification
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK}}
          LINES_ADDED: ${{ env.ADDED }}
          LINES_DELETED: ${{ env.DELETED }}
          LINES_TOTAL: ${{ env.TOTAL }}
          TOTAL_LINES_CODE: ${{ env.TOTAL_LINES }}
        run: |
          curl -X POST \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [{
              "title": "ðŸš€ Ny uppdatering pÃ¥ main!",
              "description": "Senaste commit:\n**${{ github.event.head_commit.message }}**",
              "color": 65280,
              "fields": [
                { 
                  "name": "Gjort av", 
                  "value": "${{ github.event.head_commit.committer.name }}", 
                  "inline": true 
                },
                {
                  "name": "Antal rader kod Ã¤ndrat", 
                  "value": "**Lagt till:** ${{ env.LINES_ADDED }}\n**Borttagna:** ${{ env.LINES_DELETED }}\n**Totalt:** ${{ env.LINES_TOTAL }}", 
                  "inline": false
                }, 
                {
                  "name": "Totalt antal rader kod i projektet",
                  "value": "**${{ env.TOTAL_LINES_CODE }} rader**",
                  "inline": false
                },
                { 
                  "name": "Klicka hÃ¤r fÃ¶r commit-detaljer", 
                  "value": "[Visa commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})", 
                  "inline": true 
                },
                { 
                  "name": "Repository", 
                  "value": "[Visa repository](https://github.com/${{ github.repository }})", 
                  "inline": false 
                }
              ],
              "footer": { 
                "text": "Pushat till main ðŸŽ‰" 
              },
              "timestamp": "${{ github.event.head_commit.timestamp }}"
            }]
          }' \
          $DISCORD_WEBHOOK_URL
